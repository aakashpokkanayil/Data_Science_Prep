use test;

SELECT EID, NAME,  CITY, DOJ FROM EMP -- OUTER \MAIN
WHERE EID IN(SELECT EID FROM EMP_SAL WHERE DESI = 'MANAGER'); --INNER \SUB

SELECT EID, DEPT, DESI, SALARY FROM EMP_SAL
WHERE EID IN(SELECT EID FROM EMP WHERE CITY = 'DEHRADUN');

SELECT EMP.EID, NAME , DEPT , DESI
FROM EMP
INNER JOIN EMP_SAL
ON   EMP.EID = EMP_SAL.EID
WHERE DEPT = 'MIS';

SELECT * FROM TRAINING;

-- INSERT SUB QUERY
INSERT INTO TRAINING (EID, NAME, DEPT)
SELECT EMP.EID, NAME , DEPT 
FROM EMP
INNER JOIN EMP_SAL
ON   EMP.EID = EMP_SAL.EID
WHERE DEPT = 'MIS';

UPDATE TRAINING SET MODULE = 'SQL';

-- DELETE SUB QUERY

DELETE FROM TRAINING
WHERE EID IN (SELECT  EID FROM EMP_SAL WHERE DESI LIKE 'MANAGER%');


SELECT EID, DEPT, DESI, SALARY FROM EMP_SAL
WHERE EID IN (SELECT EID FROM EMP WHERE CITY = 'PUNE');

-- UPDATE SUB QUERY

UPDATE EMP_SAL SET SALARY = SALARY + 5000
WHERE EID IN (SELECT EID FROM EMP WHERE CITY = 'PUNE');

SELECT EID, NAME,  CITY, DOJ FROM EMP
WHERE EID IN(SELECT EID FROM EMP_SAL WHERE DESI = 'MANAGER');

SELECT EID, NAME,  CITY, DOJ FROM EMP
WHERE EID IN(SELECT EID FROM EMP_SAL WHERE SALARY > 300000 )
ORDER BY EID DESC;

SELECT EID, NAME,  CITY, DOJ FROM EMP
WHERE EID IN (SELECT EID FROM EMP_SAL WHERE SALARY > 550000 );

SELECT EID, NAME,  CITY, DOJ FROM EMP
WHERE EID IN (SELECT EID FROM EMP_SAL WHERE SALARY BETWEEN 300000 AND 400000 );


SELECT COUNT(EID) AS 'NO OF EMP', AVG(SALARY) AS 'AVGSAL' FROM  EMP_SAL;

SELECT COUNT(EID) AS 'NO OF DEL EMP', AVG(SALARY) AS 'DELAVGSAL' FROM  EMP_SAL
WHERE EID IN (SELECT EID FROM EMP WHERE CITY = 'DELHI');

SELECT COUNT(EID) AS 'NO OF DEL EMP > 200K', AVG(SALARY) AS 'DELAVGSAL' FROM  EMP_SAL  --A
WHERE EID IN (SELECT EID FROM EMP WHERE CITY = 'DELHI' AND -- B
				EID IN (SELECT EID FROM EMP_SAL WHERE SALARY > 200000)); --C

-- A => B => C A=>C

SELECT * FROM EMP_SAL WHERE DEPT = 'HR'
AND EXISTS (SELECT * FROM EMP_SAL WHERE DEPT = 'HR' AND SALARY > 500000);


CREATE PROCEDURE L46DEMP
AS
BEGIN
	SELECT * FROM EMP
	WHERE CITY = 'DELHI';
END;

EXECUTE L46DEMP;

EXEC L46DEMP;

L46DEMP;

DROP PROCEDURE L46DEMP;

CREATE PROCEDURE L46DEMP @C AS VARCHAR(20)
AS
BEGIN
	SELECT * FROM EMP
	WHERE CITY = @C;
END;

L46DEMP 'DELHI';

CREATE PROCEDURE L46SHOW @T AS VARCHAR(20)
AS
BEGIN
	EXEC ('SELECT * FROM ' + @T);
END;

L46SHOW 'TRAINING';

SELECT * FROM EMP;

INSERT INTO EMP
VALUES(1247, 'GOLDY CHADHA', 'MAHAGUN ENCLAVE', 'SECTOR 71', 'NOIDA','9811131210', 'GCHADHA@GMAIL.COM', '15-MAR-1996', '07-JUL-2021');

DELETE FROM EMP WHERE EID = 1247;
DELETE FROM EMP_SAL WHERE EID = 1247;

DROP PROCEDURE L46INEMP;

CREATE PROCEDURE L46INEMP @ID AS INT, @N AS VARCHAR(30),@A1 AS VARCHAR(30),@A2 AS VARCHAR(30),@C AS VARCHAR(30), @PH AS CHAR(15), @EM AS VARCHAR(50),@DB AS DATE,  @DJ AS DATE
AS
BEGIN
	INSERT INTO EMP
	VALUES(@ID, @N, @A1,@A2, @C, @PH, @EM, @DB, @DJ);
END;

CREATE PROCEDURE L46INEMP @ID AS INT, @N AS VARCHAR(30),@A1 AS VARCHAR(30),@A2 AS VARCHAR(30),@C AS VARCHAR(30), @PH AS CHAR(15), @EM AS VARCHAR(50),@DB AS DATE,  @DJ AS DATE, @DPT AS VARCHAR(10), @DSI AS VARCHAR(20), @S AS INT
AS
BEGIN
	SET NOCOUNT ON;
	INSERT INTO EMP
	VALUES(@ID, @N, @A1,@A2, @C, @PH, @EM, @DB, @DJ);
	
	INSERT INTO EMP_SAL
	VALUES(@ID, @DPT, @DSI, @S);

	SELECT * FROM EMP WHERE EID = @ID;
	SELECT * FROM EMP_SAL WHERE EID = @ID;

	SELECT EMP.EID, NAME, CITY, DOJ, DEPT, DESI, SALARY AS 'BASIC', SALARY *.15 AS 'HRA', SALARY *.09 AS'PF'
	FROM EMP
	INNER JOIN EMP_SAL
	ON EMP.EID = EMP_SAL.EID
	WHERE EMP.EID = @ID; 
END;

SELECT * FROM EMP_SAL;

L46INEMP 1247, 'GOLDY CHADHA', 'MAHAGUN ENCLAVE', 'SECTOR 71', 'NOIDA','9811131210', 'GCHADHA@GMAIL.COM', '15-MAR-1996', '07-JUL-2021';

L46INEMP 1247, 'GOLDY CHADHA', 'MAHAGUN ENCLAVE', 'SECTOR 71', 'NOIDA','9811131210', 'GCHADHA@GMAIL.COM', '15-MAR-1996', '07-JUL-2021', 'TEMP', 'SR.ASSOCIATE', 80000;

USE LEARN46;

CREATE TABLE TEMP
(ID INT,
NAME VARCHAR(10));


INSERT INTO TEMP VALUES (1,'A');
INSERT INTO TEMP VALUES (2,'B');
INSERT INTO TEMP VALUES (3,'C');
INSERT INTO TEMP VALUES (4,'D');
INSERT INTO TEMP VALUES (5,'E');
INSERT INTO TEMP VALUES (6,'F');
INSERT INTO TEMP VALUES (7,'G');
INSERT INTO TEMP VALUES (8,'H');
INSERT INTO TEMP VALUES (9,'I');
INSERT INTO TEMP VALUES (10,'J');

SELECT * FROM TEMP;

DELETE FROM TEMP WHERE ID = 10;

BEGIN TRANSACTION;

DELETE FROM TEMP WHERE ID = 9;

ROLLBACK;

BEGIN TRANSACTION;

DELETE FROM TEMP WHERE ID = 9;
DELETE FROM TEMP WHERE ID = 8;
DELETE FROM TEMP WHERE ID = 7;
DELETE FROM TEMP WHERE ID = 6;

ROLLBACK;

SELECT * FROM TEMP;

BEGIN TRANSACTION;

DELETE FROM TEMP WHERE ID = 4;
DELETE FROM TEMP WHERE ID = 5;

SAVE TRANSACTION T1; -- SAVE POINT
DELETE FROM TEMP WHERE ID = 6;

SAVE TRANSACTION T2;
DELETE FROM TEMP WHERE ID = 7;
DELETE FROM TEMP WHERE ID = 8;
SAVE TRANSACTION T3;
DELETE FROM TEMP WHERE ID = 9;

ROLLBACK TRANSACTION T1;

SELECT * FROM TEMP;

BEGIN TRANSACTION;

DELETE FROM TEMP WHERE ID = 9;
COMMIT;

ROLLBACK;